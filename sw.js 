// Service Worker ูููุณุฎุฉ ุงููุฎุตุตุฉ ูููุณุชุฎุฏููู - ูุญูุงุช ุงูุญุฌุงูู
const CACHE_NAME = 'alhajami-user-app-v2.0';
const urlsToCache = [
  './',
  './index.html',
  './manifest.json',
  'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css',
  'https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap',
  'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js',
  'https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js',
  'https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js',
  'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/alhijama%2F472208534_122180270408092809_6379164161521111948_n.jpg?alt=media&token=c2381395-7d6c-460c-a197-1a42d05b42c1'
];

// ุชุซุจูุช Service Worker
self.addEventListener('install', (event) => {
  console.log('๐ง Service Worker: ุชู ุงูุชุซุจูุช ูููุณุฎุฉ ุงูุฎุงุตุฉ ุจุงููุณุชุฎุฏููู');
  
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('๐ฆ Service Worker: ุชู ูุชุญ ุงููุงุด ูููุณุชุฎุฏููู');
        return cache.addAll(urlsToCache);
      })
      .catch((error) => {
        console.error('โ Service Worker: ุฎุทุฃ ูู ุงูุชุซุจูุช:', error);
      })
  );
  
  // ูุฑุถ ุงูุชูุนูู ุงูููุฑู
  self.skipWaiting();
});

// ุชูุนูู Service Worker
self.addEventListener('activate', (event) => {
  console.log('โ Service Worker: ุชู ุงูุชูุนูู ูููุณุฎุฉ ุงูุฎุงุตุฉ ุจุงููุณุชุฎุฏููู');
  
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          // ุญุฐู ุงููุงุด ุงููุฏูู
          if (cacheName !== CACHE_NAME && cacheName.includes('alhajami')) {
            console.log('๐๏ธ Service Worker: ุญุฐู ุงููุงุด ุงููุฏูู:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    }).then(() => {
      // ุงูุชุญูู ูู ุฌููุน ุงูุนููุงุก
      return self.clients.claim();
    })
  );
});

// ุงุนุชุฑุงุถ ุงูุทูุจุงุช ูุน ุชุญุณููุงุช ูููุณุชุฎุฏููู
self.addEventListener('fetch', (event) => {
  // ุชุฌุงูู ุทูุจุงุช ุบูุฑ HTTP/HTTPS
  if (!event.request.url.startsWith('http')) {
    return;
  }
  
  // ุชุฌุงูู ุทูุจุงุช Firebase ุงูุฏููุงููููุฉ
  if (event.request.url.includes('firebaseapp.com') && 
      (event.request.url.includes('__/auth/') || 
       event.request.url.includes('__/firebase/') ||
       event.request.method !== 'GET')) {
    return fetch(event.request);
  }
  
  // ุงุณุชุฑุงุชูุฌูุฉ ุฎุงุตุฉ ููููุชุฌุงุช ูุงูุฅุนูุงูุงุช
  if (event.request.url.includes('/products') || 
      event.request.url.includes('/ads') ||
      event.request.url.includes('/popupAds')) {
    event.respondWith(
      fetch(event.request)
        .then(response => {
          // ุญูุธ ูุณุฎุฉ ูู ุงููุงุด
          if (response.status === 200) {
            const responseClone = response.clone();
            caches.open(CACHE_NAME)
              .then(cache => cache.put(event.request, responseClone));
          }
          return response;
        })
        .catch(() => {
          // ุฅุฑุฌุงุน ูู ุงููุงุด ุนูุฏ ูุดู ุงูุดุจูุฉ
          return caches.match(event.request);
        })
    );
    return;
  }
  
  event.respondWith(
    caches.match(event.request)
      .then((response) => {
        // ุฅุฑุฌุงุน ูู ุงููุงุด ุฅุฐุง ููุฌุฏ
        if (response) {
          console.log('๐พ Service Worker: ูู ุงููุงุด:', event.request.url);
          return response;
        }
        
        // ูุญุงููุฉ ุฌูุจ ูู ุงูุดุจูุฉ
        return fetch(event.request)
          .then((response) => {
            // ุงูุชุญูู ูู ุตุญุฉ ุงูุงุณุชุฌุงุจุฉ
            if (!response || response.status !== 200 || response.type !== 'basic') {
              return response;
            }
            
            // ูุณุฎ ุงูุงุณุชุฌุงุจุฉ ูููุงุด
            const responseToCache = response.clone();
            
            // ุญูุธ ูู ุงููุงุด ููููุงุฑุฏ ุงููููุฉ ููุท
            if (shouldCache(event.request.url)) {
              caches.open(CACHE_NAME)
                .then((cache) => {
                  cache.put(event.request, responseToCache);
                });
            }
            
            return response;
          })
          .catch((error) => {
            console.log('๐ Service Worker: ุฎุทุฃ ูู ุงูุดุจูุฉ:', error);
            
            // ุฅุฑุฌุงุน ุตูุญุฉ ุจุฏููุฉ ุนูุฏ ุนุฏู ุงูุงุชุตุงู
            if (event.request.destination === 'document') {
              return caches.match('./');
            }
            
            // ุฅุฑุฌุงุน ุตูุฑุฉ ุจุฏููุฉ ููุตูุฑ
            if (event.request.destination === 'image') {
              return new Response(
                '<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">' +
                '<rect width="400" height="300" fill="#1E293B"/>' +
                '<circle cx="200" cy="120" r="40" fill="#8B5CF6" opacity="0.3"/>' +
                '<text x="200" y="180" text-anchor="middle" font-family="Tajawal, Arial" font-size="16" fill="#94A3B8">ูุญูุงุช ุงูุญุฌุงูู</text>' +
                '<text x="200" y="200" text-anchor="middle" font-family="Tajawal, Arial" font-size="12" fill="#64748B">ุบูุฑ ูุชุตู</text>' +
                '</svg>',
                { 
                  headers: { 
                    'Content-Type': 'image/svg+xml',
                    'Cache-Control': 'max-age=86400'
                  } 
                }
              );
            }
            
            throw error;
          });
      })
  );
});

// ุชุญุฏูุฏ ุงููููุงุช ุงูุชู ูุฌุจ ุญูุธูุง ูู ุงููุงุด
function shouldCache(url) {
  // ุญูุธ ุงูุตูุฑ ูู Firebase Storage
  if (url.includes('firebasestorage.googleapis.com')) {
    return true;
  }
  
  // ุญูุธ ูููุงุช CSS ู JS
  if (url.includes('.css') || url.includes('.js')) {
    return true;
  }
  
  // ุญูุธ ุงูุฎุทูุท
  if (url.includes('fonts.googleapis.com') || url.includes('fonts.gstatic.com')) {
    return true;
  }
  
  // ุญูุธ ุฃููููุงุช Font Awesome
  if (url.includes('font-awesome') || url.includes('cdnjs.cloudflare.com')) {
    return true;
  }
  
  return false;
}

// ุฑุณุงุฆู ุฅูู ุงูุนููู
self.addEventListener('message', (event) => {
  console.log('๐จ Service Worker: ุฑุณุงูุฉ ูู ุงูุนููู:', event.data);
  
  if (event.data && event.data.type === 'SKIP_WAITING') {
    self.skipWaiting();
  }
  
  if (event.data && event.data.type === 'GET_VERSION') {
    event.ports[0].postMessage({ 
      version: CACHE_NAME,
      userApp: true,
      features: ['shopping', 'favorites', 'social_media']
    });
  }
  
  if (event.data && event.data.type === 'CLEAR_CACHE') {
    event.waitUntil(
      caches.delete(CACHE_NAME).then(() => {
        event.ports[0].postMessage({ cleared: true });
      })
    );
  }
});

// ูุนุงูุฌุฉ ุงูุฅุดุนุงุฑุงุช Push ูููุณุชุฎุฏููู
self.addEventListener('push', (event) => {
  console.log('๐ Service Worker: ุฅุดุนุงุฑ Push ูููุณุชุฎุฏููู');
  
  let notificationData = {
    title: 'ูุญูุงุช ุงูุญุฌุงูู',
    body: 'ุนุฑูุถ ุฌุฏูุฏุฉ ูููุชุฌุงุช ุฑุงุฆุนุฉ ูู ุงูุชุธุงุฑู!',
    icon: 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/alhijama%2F472208534_122180270408092809_6379164161521111948_n.jpg?alt=media&token=c2381395-7d6c-460c-a197-1a42d05b42c1',
    badge: 'https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/alhijama%2F472208534_122180270408092809_6379164161521111948_n.jpg?alt=media&token=c2381395-7d6c-460c-a197-1a42d05b42c1',
    data: {
      url: './',
      timestamp: Date.now()
    },
    actions: [
      {
        action: 'view_products',
        title: '๐๏ธ ุชุตูุญ ุงูููุชุฌุงุช'
      },
      {
        action: 'view_offers',
        title: '๐ท๏ธ ุนุฑุถ ุงูุนุฑูุถ'
      },
      {
        action: 'open_social',
        title: '๐ฑ ูุชุงุจุนุฉ ุนูู ุงูุณูุดุงู'
      }
    ],
    tag: 'alhajami-user-notification',
    renotify: true,
    vibrate: [200, 100, 200],
    requireInteraction: false
  };
  
  if (event.data) {
    try {
      const pushData = event.data.json();
      notificationData = { ...notificationData, ...pushData };
    } catch (e) {
      notificationData.body = event.data.text() || notificationData.body;
    }
  }
  
  event.waitUntil(
    self.registration.showNotification(notificationData.title, notificationData)
  );
});

// ูุนุงูุฌุฉ ุงูููุฑ ุนูู ุงูุฅุดุนุงุฑุงุช ูููุณุชุฎุฏููู
self.addEventListener('notificationclick', (event) => {
  console.log('๐ Service Worker: ููุฑ ุนูู ุงูุฅุดุนุงุฑ - ุงููุณุชุฎุฏููู');
  
  event.notification.close();
  
  let targetUrl = './';
  
  if (event.action === 'view_products') {
    targetUrl = './?category=all';
  } else if (event.action === 'view_offers') {
    targetUrl = './?category=offers';
  } else if (event.action === 'open_social') {
    // ูุชุญ ุงูุตูุญุงุช ุงูุงุฌุชูุงุนูุฉ
    event.waitUntil(
      Promise.all([
        clients.openWindow('https://www.facebook.com/share/1EwLZcL21p/'),
        clients.openWindow('https://www.instagram.com/a__1257a?igsh=eDN3dHlmcTA1MGxt')
      ])
    );
    return;
  } else if (event.notification.data && event.notification.data.url) {
    targetUrl = event.notification.data.url;
  }
  
  event.waitUntil(
    clients.matchAll({
      type: 'window',
      includeUncontrolled: true
    }).then(clientList => {
      // ุงูุจุญุซ ุนู ูุงูุฐุฉ ููุชูุญุฉ ููุชุทุจูู
      for (let client of clientList) {
        if (client.url.includes(self.location.origin) && 'focus' in client) {
          client.focus();
          client.navigate(targetUrl);
          return;
        }
      }
      
      // ูุชุญ ูุงูุฐุฉ ุฌุฏูุฏุฉ ุฅุฐุง ูู ุชูุฌุฏ
      if (clients.openWindow) {
        return clients.openWindow(targetUrl);
      }
    })
  );
});

// ูุนุงูุฌุฉ ุชุฒุงูู ุงูุจูุงูุงุช ูู ุงูุฎูููุฉ ูููุณุชุฎุฏููู
self.addEventListener('sync', (event) => {
  console.log('๐ Service Worker: ูุฒุงููุฉ ุงูุจูุงูุงุช - ุงููุณุชุฎุฏููู:', event.tag);
  
  if (event.tag === 'background-sync-user') {
    event.waitUntil(doUserBackgroundSync());
  } else if (event.tag === 'sync-favorites') {
    event.waitUntil(syncUserFavorites());
  } else if (event.tag === 'sync-cart') {
    event.waitUntil(syncUserCart());
  }
});

// ุฏุงูุฉ ูุฒุงููุฉ ุงูุจูุงูุงุช ูููุณุชุฎุฏููู
async function doUserBackgroundSync() {
  try {
    console.log('๐ Service Worker: ุจุฏุก ูุฒุงููุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู');
    
    // ูุฒุงููุฉ ุงูููุถูุฉ
    await syncUserFavorites();
    
    // ูุฒุงููุฉ ุงูุณูุฉ
    await syncUserCart();
    
    // ุชุญุฏูุซ ุงูููุชุฌุงุช
    await updateProductsCache();
    
    // ุชุญุฏูุซ ุงูุฅุนูุงูุงุช
    await updateAdsCache();
    
    console.log('โ Service Worker: ุชูุช ูุฒุงููุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู');
    return Promise.resolve();
  } catch (error) {
    console.error('โ Service Worker: ุฎุทุฃ ูู ูุฒุงููุฉ ุจูุงูุงุช ุงููุณุชุฎุฏููู:', error);
    throw error;
  }
}

// ูุฒุงููุฉ ุงูููุถูุฉ
async function syncUserFavorites() {
  try {
    // ูููู ุฅุถุงูุฉ ููุทู ูุฒุงููุฉ ุงูููุถูุฉ ูุน ุงูุฎุงุฏู ููุง
    console.log('โค๏ธ Service Worker: ูุฒุงููุฉ ุงูููุถูุฉ');
    return Promise.resolve();
  } catch (error) {
    console.error('โ Service Worker: ุฎุทุฃ ูู ูุฒุงููุฉ ุงูููุถูุฉ:', error);
    throw error;
  }
}

// ูุฒุงููุฉ ุงูุณูุฉ
async function syncUserCart() {
  try {
    // ูููู ุฅุถุงูุฉ ููุทู ูุฒุงููุฉ ุงูุณูุฉ ูุน ุงูุฎุงุฏู ููุง
    console.log('๐ Service Worker: ูุฒุงููุฉ ุงูุณูุฉ');
    return Promise.resolve();
  } catch (error) {
    console.error('โ Service Worker: ุฎุทุฃ ูู ูุฒุงููุฉ ุงูุณูุฉ:', error);
    throw error;
  }
}

// ุชุญุฏูุซ ูุงุด ุงูููุชุฌุงุช
async function updateProductsCache() {
  try {
    const cache = await caches.open(CACHE_NAME);
    
    // ูุญุงููุฉ ุชุญุฏูุซ ุจูุงูุงุช ุงูููุชุฌุงุช
    const productsUrl = 'https://messageemeapp-default-rtdb.firebaseio.com/products.json';
    try {
      const response = await fetch(productsUrl);
      if (response.ok) {
        await cache.put(productsUrl, response);
        console.log('๐ฆ Service Worker: ุชู ุชุญุฏูุซ ูุงุด ุงูููุชุฌุงุช');
      }
    } catch (error) {
      console.warn('โ๏ธ Service Worker: ูู ูุชู ุชุญุฏูุซ ูุงุด ุงูููุชุฌุงุช:', error.message);
    }
    
    return Promise.resolve();
  } catch (error) {
    console.error('โ Service Worker: ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุด ุงูููุชุฌุงุช:', error);
    throw error;
  }
}

// ุชุญุฏูุซ ูุงุด ุงูุฅุนูุงูุงุช
async function updateAdsCache() {
  try {
    const cache = await caches.open(CACHE_NAME);
    
    // ุชุญุฏูุซ ุงูุฅุนูุงูุงุช ุงูุนุงุฏูุฉ
    const adsUrl = 'https://messageemeapp-default-rtdb.firebaseio.com/ads.json';
    try {
      const response = await fetch(adsUrl);
      if (response.ok) {
        await cache.put(adsUrl, response);
        console.log('๐ข Service Worker: ุชู ุชุญุฏูุซ ูุงุด ุงูุฅุนูุงูุงุช');
      }
    } catch (error) {
      console.warn('โ๏ธ Service Worker: ูู ูุชู ุชุญุฏูุซ ูุงุด ุงูุฅุนูุงูุงุช:', error.message);
    }
    
    // ุชุญุฏูุซ ุงูุฅุนูุงูุงุช ุงูููุจุซูุฉ
    const popupAdsUrl = 'https://messageemeapp-default-rtdb.firebaseio.com/popupAds.json';
    try {
      const response = await fetch(popupAdsUrl);
      if (response.ok) {
        await cache.put(popupAdsUrl, response);
        console.log('๐ฏ Service Worker: ุชู ุชุญุฏูุซ ูุงุด ุงูุฅุนูุงูุงุช ุงูููุจุซูุฉ');
      }
    } catch (error) {
      console.warn('โ๏ธ Service Worker: ูู ูุชู ุชุญุฏูุซ ูุงุด ุงูุฅุนูุงูุงุช ุงูููุจุซูุฉ:', error.message);
    }
    
    return Promise.resolve();
  } catch (error) {
    console.error('โ Service Worker: ุฎุทุฃ ูู ุชุญุฏูุซ ูุงุด ุงูุฅุนูุงูุงุช:', error);
    throw error;
  }
}

// ูุนุงูุฌุฉ ุชุญุฏูุซุงุช ุงููุงุด ุงูุฏูุฑูุฉ ูููุณุชุฎุฏููู
self.addEventListener('periodicsync', (event) => {
  if (event.tag === 'update-user-cache') {
    event.waitUntil(updateUserCache());
  }
});

// ุชุญุฏูุซ ุงููุงุด ุฏูุฑูุงู ูููุณุชุฎุฏููู
async function updateUserCache() {
  try {
    console.log('๐ Service Worker: ุจุฏุก ุงูุชุญุฏูุซ ุงูุฏูุฑู ูููุณุชุฎุฏููู');
    
    const cache = await caches.open(CACHE_NAME);
    const requests = await cache.keys();
    
    // ุชุญุฏูุซ ุงููููุงุช ุงููููุฉ ููุท
    const importantUrls = requests.filter(request => 
      shouldCache(request.url) || 
      request.url.includes('/products') ||
      request.url.includes('/ads') ||
      request.url.includes('/popupAds')
    );
    
    const updatePromises = importantUrls.map(async (request) => {
      try {
        const response = await fetch(request);
        if (response.status === 200) {
          await cache.put(request, response);
          console.log('โ Service Worker: ุชู ุชุญุฏูุซ:', request.url);
        }
      } catch (error) {
        console.warn('โ๏ธ Service Worker: ุฎุทุฃ ูู ุชุญุฏูุซ:', request.url, error.message);
      }
    });
    
    await Promise.all(updatePromises);
    console.log('โ Service Worker: ุชู ุงูุชุญุฏูุซ ุงูุฏูุฑู ูููุณุชุฎุฏููู');
  } catch (error) {
    console.error('โ Service Worker: ุฎุทุฃ ูู ุงูุชุญุฏูุซ ุงูุฏูุฑู:', error);
  }
}

// ุฅุญุตุงุฆูุงุช ุงุณุชุฎุฏุงู ุงูุชุทุจูู
self.addEventListener('fetch', (event) => {
  // ุชุชุจุน ุงุณุชุฎุฏุงู ุงูุชุทุจูู (ุจุฏูู ูุนูููุงุช ุดุฎุตูุฉ)
  if (event.request.url.includes(self.location.origin)) {
    logAppUsage(event.request.url);
  }
});

function logAppUsage(url) {
  // ุฅุญุตุงุฆูุงุช ุจุณูุทุฉ ูุชุญุณูู ุงูุชุทุจูู
  try {
    const usage = {
      timestamp: Date.now(),
      page: url.split('/').pop() || 'home',
      userAgent: 'PWA-User'
    };
    
    // ูููู ุฅุฑุณุงู ุงูุฅุญุตุงุฆูุงุช ูุชุญููู ุงูุงุณุชุฎุฏุงู (ูุน ุงุญุชุฑุงู ุงูุฎุตูุตูุฉ)
    console.log('๐ Service Worker: ุงุณุชุฎุฏุงู ุงูุชุทุจูู:', usage.page);
  } catch (error) {
    // ุชุฌุงูู ุฃุฎุทุงุก ุงูุฅุญุตุงุฆูุงุช
  }
}

console.log('๐ Service Worker ูุญูุงุช ุงูุญุฌุงูู - ูุณุฎุฉ ุงููุณุชุฎุฏููู ุฌุงูุฒ ููุนูู!');
console.log('๐๏ธ ุงูููุฒุงุช ุงููุชุงุญุฉ: ุงูุชุณููุ ุงูููุถูุฉุ ุงูุณูุฉุ ุงูุฑูุงุจุท ุงูุงุฌุชูุงุนูุฉ');
console.log('๐ฑ ุงูููุตุงุช ุงูุงุฌุชูุงุนูุฉ: ููุณุจููุ ุฅูุณุชุบุฑุงู');
console.log('๐ ุงูุฅุดุนุงุฑุงุช: ููุนูุฉ ููุนุฑูุถ ูุงูููุชุฌุงุช ุงูุฌุฏูุฏุฉ');